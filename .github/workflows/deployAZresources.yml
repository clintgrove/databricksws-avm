name: Deploy Bicep file
on:
  workflow_dispatch:
    inputs:
      paramRG:
        description: 'Parameter for resource group'
        required: true
        default: 'dbr-private-rg-1'
  push:
    branches:
      - main

jobs:
  deploy-databricks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@main

      - name: Set up Azure credentials
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure subscription context
        run: az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION }}
      - name: Databricks Deploy Bicep file
        uses: azure/arm-deploy@v1
        with:
          resourceGroupName: ${{ secrets.AZURE_RG }}
          template: ./main.bicep
          failOnStdErr: false

  deploy-vm:
        runs-on: ubuntu-latest
        needs:  deploy-databricks

        steps:
        - name: Checkout code
          uses: actions/checkout@main

        - name: Set up Azure credentials
          uses: azure/login@v1
          with:
            creds: ${{ secrets.AZURE_CREDENTIALS }}

        - name: Set Azure subscription context
          run: az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION }}

        - name: VM Deploy Bicep file
          uses: azure/arm-deploy@v1
          with:
            resourceGroupName: ${{ secrets.AZURE_RG }}
            template: ./vm.bicep
            failOnStdErr: false

  deploy-storage:
      runs-on: ubuntu-latest
      needs:  
        - deploy-databricks
        - deploy-vm

      steps:
      - name: Checkout code
        uses: actions/checkout@main

      - name: Set up Azure credentials
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure subscription context
        run: az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION }}

      - name: Storage Deploy Bicep file
        uses: azure/arm-deploy@v1
        with:
         resourceGroupName: ${{ secrets.AZURE_RG }}
         template: ./storage.bicep
         failOnStdErr: false
